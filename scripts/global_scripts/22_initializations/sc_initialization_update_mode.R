# UPDATE_MODE Initialization --------------------------------------------------
# Minimal initialization for update/batch scripts.

# Ensure autoinit() has been executed -----------------------------------------
if (!exists(".InitEnv") || !is.environment(.InitEnv)) {
  stop("autoinit() must be executed before sourcing sc_initialization_app_mode.R")
}

# Abort if already initialized -------------------------------------------------
if (exists("INITIALIZATION_COMPLETED") && INITIALIZATION_COMPLETED) {
  message("Initialization already completed ‚Äì skipping.")
}

# -----------------------------------------------------------------------------
# 1. Environment flags
# -----------------------------------------------------------------------------
if (!exists("OPERATION_MODE", envir = .GlobalEnv)) {
  stop("OPERATION_MODE is not defined. Please set OPERATION_MODE before sourcing this script.")
}
options(app.verbose = getOption("app.verbose", FALSE))


# -----------------------------------------------------------------------------
# 2. Package initialization
# -----------------------------------------------------------------------------
source(file.path(GLOBAL_DIR, "04_utils", "fn_initialize_packages.R"))
source(file.path(GLOBAL_DIR, "04_utils", "base", "fn_library2.R"))
initialize_packages(mode = OPERATION_MODE,
                    verbose = getOption("update.verbose", FALSE),
                    force_update = FALSE)

# -----------------------------------------------------------------------------
# 3. Load global scripts in deterministic order
# -----------------------------------------------------------------------------
source(file.path(GLOBAL_DIR, "04_utils", "fn_get_r_files_recursive.R"))
load_dirs <- c(
  "14_sql_utils",
  "02_db_utils",
  "04_utils",
  "03_config",
  "01_db",
  "05_etl_utils",
  "06_queries",
  "05_data_processing",
  "07_models",
  "08_ai",
  "09_python_scripts",
  "10_rshinyapp_components",
  "11_rshinyapp_utils",
  "17_transform"
)

# Enhanced debugging for file loading
cat("üîß Starting to load global scripts...\n")
total_files_loaded <- 0
total_errors <- 0

for (d in load_dirs) {
  dir_path <- file.path(.InitEnv$GLOBAL_DIR, d)
  if (!dir.exists(dir_path)) {
    cat("‚è≠Ô∏è  Skipping non-existent directory:", d, "\n")
    next
  }
  
  cat("üìÅ Loading directory:", d, "\n")
  r_files <- sort(get_r_files_recursive(dir_path))
  
  if (length(r_files) == 0) {
    cat("   ‚ÑπÔ∏è  No R files found in", d, "\n")
    next
  }
  
  cat("   üìã Found", length(r_files), "R files\n")
  
  # Load each file with individual error handling
  for (file_path in r_files) {
    tryCatch({
      cat("   üîÑ Loading:", basename(file_path), "...")
      source(file_path, local = FALSE)
      cat(" ‚úÖ\n")
      total_files_loaded <- total_files_loaded + 1
    }, error = function(e) {
      cat(" ‚ùå\n")
      cat("   ‚ö†Ô∏è  ERROR in file:", file_path, "\n")
      cat("   üìÑ Error message:", e$message, "\n")
      cat("   üîç Call stack:", deparse(e$call), "\n")
      total_errors <- total_errors + 1
      
      # Continue loading other files instead of stopping
      warning("Failed to load: ", file_path, " - ", e$message)
    })
  }
  cat("   ‚úÖ Completed directory:", d, "\n\n")
}

cat("üìä Loading Summary:\n")
cat("   ‚úÖ Successfully loaded:", total_files_loaded, "files\n")
cat("   ‚ùå Failed to load:", total_errors, "files\n")
if (total_errors > 0) {
  cat("   ‚ö†Ô∏è  Check warnings() for detailed error information\n")
}
cat("üéØ Global scripts loading completed!\n\n")

# -----------------------------------------------------------------------------
# 4. Finalize
# -----------------------------------------------------------------------------
INITIALIZATION_COMPLETED <- TRUE
message("UPDATE_MODE initialization finished. Databases available: ",
        paste(names(db_path_list), collapse = ", "))

