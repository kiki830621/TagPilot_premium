# 資料清洗與處理階段萃取 ID 指南

> **核心結論：**  
> *凡是關係到「資料唯一性、去重、外鍵」的 ID，要在 **Cleanse** 階段就確定；與分析邏輯綁定的衍生 ID，留在 **Process** 階段產生。*

---

## 1. 兩大階段目的

| 階段                 | 主要目標                                         | 常見動作                           | 為什麼重要？                   |
| -------------------- | ------------------------------------------------ | ---------------------------------- | ------------------------------ |
| **Cleanse / 清理層** | 修補 **資料品質**，讓資料可以被信任              | 去重、補空值、標準化型別、偵測異常 | 避免髒資料污染後續流程         |
| **Process / 處理層** | 依 **業務邏輯** 轉換，產出可直接分析／建模的資料 | 聚合、計算 KPI、特徵工程           | 把「正確」資料變成「有用」資料 |

---

## 2. ID 應該放哪一層？

| ID 用途                                                      | 建議層級              | 原因                                              |
| ------------------------------------------------------------ | --------------------- | ------------------------------------------------- |
| **唯一鍵、外鍵關聯** <br>（`customer_id`, `order_id` 等）    | **Cleanse**           | 早確立才可去重、分流，並保持後續資料 lineage 清晰 |
| **分析用衍生鍵** <br>（`week_id`, `cohort_id`, `session_id` 等） | **Process**           | 隨分析粒度變動，放 Process 彈性較高               |
| **純報表索引** <br>（前端排序流水號等）                      | **Process／最終報表** | 與商業邏輯無關，最後再產生即可                    |

---

## 3. 標準工作流程

1. **Staging（原始落地）**  
   - 只存原始檔，附加載入時間戳記。  

2. **Cleanse**  
   - 執行去重、補值、驗證。  
   - **若 ID 影響唯一性／正規化，務必在此產生或對應**。  

3. **Process / Transform**  
   - 依分析需求聚合、衍生欄位。  
   - 衍生 ID（如 `session_id` v2）在此階段生成最靈活。  

---

## 4. 為何 ID 宜早確立？

* **避免錯配：** 先有主鍵，後續聚合/關聯才不會「對錯人」。  
* **易於追溯：** 固定主鍵後，Raw → Clean → Process 的 lineage 一目瞭然。  
* **除錯方便：** 出問題可直接用同一 ID 回溯到原始列。

---

## 5. 實務技巧

| 技巧                                | 說明                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| **雜湊/UUID 臨時鍵**                | 原始資料無自然鍵時，在 Cleanse 先產生 `raw_row_hash`。       |
| **把 ID 邏輯封裝成 UDF / SQL 模組** | 隔離邏輯、方便單元測試與版本控制。                           |
| **衍生鍵加版本號**                  | 例如 `session_id_v2`，避免改版影響歷史報表。                 |
| **同步更新資料字典**                | ID 一旦確立，立即在 data catalog / ER 圖標註，提高跨團隊溝通效率。 |

---