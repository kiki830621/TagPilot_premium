---
id: "S03"
title: "Product Line Mapping Sequence"
type: "sequence"
date_created: "2025-05-19"
date_modified: "2025-05-19"
author: "Claude"
related_to:
  - "R007": "Update Script Naming Convention"
  - "R113": "Update Script Structure"
  - "R120": "Filter Variable Naming Convention"
  - "D01": "DNA Analysis Derivation Flow"
---

# S03: Product Line Mapping Sequence

This sequence defines the process for creating and maintaining product line mapping data that associates individual products (by ASIN or SKU) with their product line categories. This mapping is critical for multi-dimensional analysis across both platform and product line dimensions.

## Background

Product line identification is essential for analyzing customer behavior across different product categories. The S03 sequence creates the foundation for introducing `product_line_id_filter` variables at the correct stage of data analysis flows, particularly in D01 (DNA Analysis).

## Sequence Steps

### S03_00: Create Unified Product Line product Dictionary

```
CREATE DICTIONARY FROM raw_data.df_product_profile_{product_line} UNION TO processed_data.df_product_profile_dictionary
```

- Combines product profiles from multiple product lines into a unified dictionary
- Assigns explicit product line identifiers to each product
- Uses SQL UNION ALL to combine tables efficiently
- Creates a single reference table for product line determination
- Handles naming inconsistencies across different product profile tables
- Ensures each ASIN/SKU has a proper product_line_id assignment
- Provides the foundational mapping for multi-dimensional analysis

Example SQL generation:
```R
union_sql <- glue_collapse(
  map(
    vec_product_line_id_noall,
    ~ {
      tbl_name <- paste0("df_product_profile_", .x)  
      glue_sql(
        "SELECT {sql(.x)} AS product_line_id,
                asin
         FROM   {`tbl_name`}",
        .con = raw_data
      )
    }
  ),
  sep = "\nUNION ALL\n"
)
```

### S03_01: Enhance Product Line Dictionary

```
ENHANCE DICTIONARY processed_data.df_product_profile_dictionary WITH ATTRIBUTES
```

- Adds additional attributes to the product line dictionary
- Enriches with category hierarchy information
- Incorporates product tags and classification data
- Enables more nuanced filtering and grouping
- Handles naming variations and synonyms

### S03_02: Create Product Line Categorization Rules

```
CREATE RULES FROM processed_data.df_product_profile_dictionary TO app_data.df_product_line_rules
```

- Defines rules for categorizing products without explicit mappings
- Creates fallback categorization patterns
- Uses text pattern matching for category assignment
- Handles new or unknown products gracefully
- Provides systematic categorization for complete coverage

## Integration with DNA Analysis Flow

The S03 sequence creates data needed for the D01 flow, particularly at the D01_03 step where product line filtering is first introduced:

1. **D01_00 to D01_02**: Platform-specific processing without product line filtering
2. **D01_03**: First introduction of product_line_id_filter using data from S03_00
3. **D01_04 to D01_07**: Full multi-dimensional analysis across platforms and product lines

This sequence follows Rule 120 (Filter Variable Naming Convention) by consistently using the `_filter` suffix for variables used in filtering operations, clarifying the distinction between entity IDs and filtering parameters.

## Implementation

Platform-specific implementations of this sequence can be found in the respective scripts:

- 01 (Amazon): `amz_S03_00.R`, `amz_S03_01.R`, `amz_S03_02.R`
- 06 (eBay): `ebay_S03_00.R`, `ebay_S03_01.R`, `ebay_S03_02.R`
- 07 (Cyberbiz): `cyberbiz_S03_00.R`, `cyberbiz_S03_01.R`, `cyberbiz_S03_02.R`