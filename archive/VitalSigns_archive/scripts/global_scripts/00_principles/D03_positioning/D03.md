---
id: "D03"
title: "Positioning Analysis Derivation Flow"
type: "derivation"
date_created: "2025-05-16"
date_modified: "2025-05-31"
author: "Claude"
related_to:
  - "R38": "Platform Numbering Convention"
  - "MP58": "Database Table Creation Strategy"
  - "MP43": "Database Documentation"
  - "MP73": "Interactive Visualization Preference"
  - "MP47": "Functional Programming"
  - "R21": "One Function One File"
  - "R69": "Function File Naming"
  - "MP81": "Explicit Parameter Specification"
  - "R49": "Apply Over Loops"
---

# D03: Positioning Analysis Derivation Flow

This document outlines the complete end-to-end derivation process for creating positioning analysis data, from raw external data to final application components. This derivation defines how competitive positioning data is collected, processed, and made available for visualization in the application.

## Derivation Overview

The positioning analysis derivation extracts, transforms, and loads data from external sources to the application database, providing competitive positioning data across multiple product lines. This enables visual comparison of brand attributes, ratings, and market performance.

```
EXTERNAL SOURCES → RAW DATA → CLEANSED DATA → PROCESSED DATA → APP DATA → VISUALIZATION
```

The resulting data is used by the `positionTable` component to display competitive positioning information.

## Prerequisites

1. Product line information must be configured in `app_data.parameters.product_line.csv`
2. Item dictionary must be available to map items to product lines
3. The `vec_product_line_id_noall` vector must be defined in the global environment

## Derivation Steps

### D03_00: Import Item Properties

```
IMPORT external_data.{item_property} TO raw_data.df_item_profile_{product_line_id}
```

- Imports basic item metadata for each product line
- Data includes asin, name, brand, URL, and other basic properties
- Creates separate tables for each product line
- Implemented via `fn_import_item_profiles()` function

### D03_01: Import Competitor Item IDs

```
IMPORT external_data.{competitor_items} TO raw_data.df_competitor_item_id
```

- Imports a mapping of competitor item IDs
- Identifies items to be compared in the positioning analysis
- Creates a reference table of competitor items by product line
- Implemented via `fn_import_competitor_items()` function

### D03_02: Import Comment Properties

```
IMPORT external_data.{comment_property} TO raw_data.df_comment_property
```

- Imports comment property definitions and scoring rules
- Defines the attributes to be used for positioning analysis
- Properties can include design, quality, usability, etc.
- Implemented via `fn_import_comment_properties()` function

### D03_03: Import Reviews

```
IMPORT external_raw_data.{review_data} TO raw_data.df_{source}_review_data
```

- Imports raw review data from external sources
- Sources include Amazon (amz) and other platforms
- Raw data includes review text, ratings, and metadata

### D03_04: Cleanse Reviews

```
CLEANSING raw_data.df_{source}_review_data TO cleansed_data.df_{source}_review_data
```

- Cleans and standardizes review data
- Removes duplicates and invalid entries
- Normalizes text formats and rating scales
- Prepares data for further processing
- Implemented via `fn_cleanse_amz_reviews()` function
- Displays review statistics internally without returning data

### D03_05: Process Reviews with Product Line Information and Competitor Flags

```
PROCESS cleansed_data.df_{source}_review_data TO processed_data.df_{source}_review_data
WITH product_line_id AND competitor_flags
```

- **Amazon implementation** (`fn_process_amz_reviews()`):
  - Extracts product line information from review paths
  - Normalizes product line names using make_clean_names
  - Adds product_line_id to review data through joining with product_line_df
  - Adds competitor flags by joining with competitor_item_id table
  - Keeps all reviews but marks competitor status
  
- **eBay implementation** (`fn_process_eby_reviews()`):
  - Filters to keep only reviews for items in competitor list
  - **Important**: Reviews for non-competitor items are deleted
  - Adds product_line_id from competitor data
  - Enriches with brand/seller information from competitor data
  - No is_competitor flag needed (all are competitors by definition)

- Both implementations:
  - Ensure reviews are properly categorized by product line
  - Rearrange columns for better readability (date, item_id first)
  - Show processing statistics via console messages

### D03_06: Import Comment Property Ratings

```
IMPORT comment_property_rating
```

- Imports or calculates ratings for specific comment properties
- Maps review sentiment to defined properties
- Creates initial property scores
- Creates separate tables for each product line with rating columns
- Prepares sampled data for detailed analysis
- Implemented via `fn_import_comment_property_ratings()` function
- Configurable sample size via `comment_sample_size` parameter

### D03_07: Rate Reviews

```
RATE reviews BY property IN cleansed_data.df_{source}_review_data
```

- Analyzes review text to extract sentiment by property
- Assigns scores to each property mentioned in reviews
- Uses NLP techniques (via OpenAI API) to identify property mentions
- Averages scores across multiple reviews
- Implemented via `fn_rate_comments()` and `fn_process_property_ratings()` functions
- Parallel processing with configurable worker count

### D03_08: Process Reviews

```
PROCESS cleansed_data.df_{source}_review_data TO processed_data.{source}_review
```

- Platform-specific review processing (e.g., amz_D03_08 for Amazon)
- Aggregates reviews by item
- Calculates average ratings and metrics
- Creates summary statistics
- Implemented via `fn_process_review_ratings()` function
- Includes optional data imputation for missing values using the mice package

### D03_09: Query Comment Property Ratings

```
QUERY processed_data.{source}_review BY asin TO processed_data.df_comment_property_ratingonly_by_asin_{product_line_id}
```

- Creates property ratings by ASIN
- Groups and averages ratings by item
- Prepares property scores for positioning analysis
- Implemented via `fn_process_comment_property_ratings_by_asin()` function
- Handles missing values and column cleaning

### D03_10: Import Competitor Sales Data

```
IMPORT external_data.{competitor_sales} TO raw_data.df_competitor_sales
```

- Imports sales data for competitor items
- Adds market performance metrics
- Provides additional context for positioning
- Implemented via `fn_import_df_amz_competitor_sales()` function
- Processes data organized in product line subfolders

### D03_11: Create Position Table

```
JOIN processed_data.df_comment_property_ratingonly_by_asin_{product_line_id} TO app_data.df_position
```

- Combines all processed data into the final position table
- Standardizes format for application use
- Creates the app_data.df_position table
- Implemented via three main functions:
  - `fn_process_position_table()`: Processes each product line
  - `fn_merge_position_tables()`: Merges tables from all product lines
  - `fn_finalize_position_table()`: Performs cleanup and finalization

## Final Data Structure

The `app_data.df_position` table includes:

- **product_line_id**: Product line identifier (from product_line.csv)
- **asin**: Amazon Standard Identification Number
- **brand**: Brand name
- **rating**: Overall product rating
- **sales**: Sales volume indicator
- Multiple property ratings (design, quality, etc.)
- **Ideal**: Special row showing the ideal values calculated as weighted average
- **Rating**: Special row showing rating-based ideal values
- **Revenue**: Special row showing sales-based ideal values

All data is currently sourced from Amazon ("amz"), with platform_id to be added in future updates.

## Functional Implementation

The derivation steps have been implemented following the functional programming principle (MP47) with each function encapsulated in its own file (R21):

### Import Functions
1. `fn_import_item_profiles.R` - Imports item profiles for multiple product lines
2. `fn_import_competitor_items.R` - Imports competitor item IDs
3. `fn_import_comment_properties.R` - Imports comment property definitions
4. `fn_import_comment_property_ratings.R` - Imports comment property ratings with sampling
5. `fn_import_df_amz_competitor_sales.R` - Imports competitor sales data

### Processing Functions
1. `fn_cleanse_amz_reviews.R` - Cleanses Amazon review data
2. `fn_process_amz_reviews.R` - Processes reviews with product line information
3. `fn_rate_comments.R` - Rates comments using OpenAI API
4. `fn_process_property_ratings.R` - Handles batch processing of comment ratings
5. `fn_process_review_ratings.R` - Processes review ratings into usable statistics
6. `fn_decode_rating.R` - Extracts numeric ratings from API responses
7. `fn_process_comment_property_ratings_by_asin.R` - Processes ratings by ASIN

### Position Table Functions
1. `fn_process_position_table.R` - Processes position data for a product line
2. `fn_merge_position_tables.R` - Merges product line tables
3. `fn_finalize_position_table.R` - Cleans and finalizes the position table
4. `fn_coalesce_suffix_cols.R` - Merges duplicate columns from different sources

Each function follows the naming convention with "fn_" prefix (R69) and encapsulates a specific transformation step in the derivation flow. All functions use explicit parameter naming (MP81) and prefer vectorized operations over loops (R49).

## Visualization Components

The positioning data is visualized using:

1. **positionTable**: Tabular view with filtering by product line and brand
2. **positionChart**: (Future) Visual chart of positioning metrics

The UI components follow responsive design principles and provide interactive filtering capabilities.

## Platform Implementation Notes

This derivation is implemented for multiple platforms:
- Amazon data (platform_id = "amz") with scripts amz_D03_XX.R
- eBay data (platform_id = "eby") with scripts eby_D03_XX.R

Each platform has its own set of derivation scripts for easier maintenance and modularity.

### Platform-Specific Differences

**Data Filtering Strategy:**
- **Amazon**: Keeps all reviews and adds competitor flags (inclusive approach)
- **eBay**: Filters to keep only competitor item reviews (exclusive approach)
  - This significantly reduces data volume for eBay
  - Ensures positioning analysis focuses only on tracked competitors
  - Non-competitor reviews are removed in step D03_05

## Related Principles

- **MP43 (Database Documentation)**: The schema and relationships are documented
- **MP47 (Functional Programming)**: Data processing is implemented as pure functions
- **MP58 (Database Table Creation Strategy)**: Tables follow consistent naming and structure
- **MP73 (Interactive Visualization Preference)**: Data is presented for interactive exploration
- **MP81 (Explicit Parameter Specification)**: All functions use named parameters
- **R21 (One Function One File)**: Each function is placed in its own file
- **R38 (Platform Numbering Convention)**: Standard platform identifiers are used
- **R49 (Apply Over Loops)**: Vectorized operations are used instead of explicit loops
- **R69 (Function File Naming)**: Function files follow the fn_ prefix convention

## Implementation Files

### Platform-specific Scripts
- Amazon implementation: `/update_scripts/amz_D03_*.R`
- eBay implementation: `/update_scripts/eby_D03_*.R`

### Function Implementations
- Utility functions: `/global_scripts/04_utils/fn_*.R`
- Data processing: `/global_scripts/05_data_processing/fn_*.R`
- AI functions: `/global_scripts/08_ai/fn_*.R`

### Visualization Components
- Position table: `/global_scripts/10_rshinyapp_components/position/positionTable/positionTable.R`